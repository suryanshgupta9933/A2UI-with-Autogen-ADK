{"version":3,"file":"watch.js","sources":["../src/lib/watch.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2023 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\n\nimport {DirectiveResult, Part, directive} from 'lit/directive.js';\nimport {AsyncDirective} from 'lit/async-directive.js';\nimport {Signal} from 'signal-polyfill';\nimport {SignalWatcher} from './signal-watcher.js';\n\nexport class WatchDirective<T> extends AsyncDirective {\n  private __host?: SignalWatcher;\n\n  private __signal?: Signal.State<T> | Signal.Computed<T>;\n\n  private __watcher?: Signal.subtle.Watcher;\n\n  // We have to wrap the signal in a computed to work around a bug in the\n  // signal-polyfill: https://github.com/proposal-signals/signal-polyfill/issues/27\n  private __computed?: Signal.Computed<T | undefined>;\n\n  private __watch() {\n    if (this.__watcher !== undefined) {\n      return;\n    }\n    this.__computed = new Signal.Computed(() => {\n      return this.__signal?.get();\n    });\n    const watcher = (this.__watcher = new Signal.subtle.Watcher(() => {\n      // TODO: If we're not running inside a SignalWatcher, we can commit to\n      // the DOM independently.\n      this.__host?._updateWatchDirective(this as WatchDirective<unknown>);\n      watcher.watch();\n    }));\n    watcher.watch(this.__computed);\n  }\n\n  private __unwatch() {\n    if (this.__watcher !== undefined) {\n      this.__watcher.unwatch(this.__computed!);\n      this.__computed = undefined;\n      this.__watcher = undefined;\n      this.__host?._clearWatchDirective(this as WatchDirective<unknown>);\n    }\n  }\n\n  commit() {\n    this.setValue(Signal.subtle.untrack(() => this.__computed?.get()));\n  }\n\n  render(signal: Signal.State<T> | Signal.Computed<T>): T {\n    // This would only be called if render is called directly, like in SSR.\n    return Signal.subtle.untrack(() => signal.get());\n  }\n\n  override update(\n    part: Part,\n    [signal]: [signal: Signal.State<T> | Signal.Computed<T>]\n  ) {\n    this.__host ??= part.options?.host as SignalWatcher;\n    if (signal !== this.__signal && this.__signal !== undefined) {\n      // Unwatch the old signal\n      this.__unwatch();\n    }\n    this.__signal = signal;\n    this.__watch();\n\n    // We use untrack() so that the signal access is not tracked by the watcher\n    // created by SignalWatcher. This means that an can use both SignalWatcher\n    // and watch() and a signal update won't trigger a full element update if\n    // it's only passed to watch() and not otherwise accessed by the element.\n    return Signal.subtle.untrack(() => this.__computed!.get());\n  }\n\n  protected override disconnected(): void {\n    this.__unwatch();\n  }\n\n  protected override reconnected(): void {\n    this.__watch();\n  }\n}\n\nexport type WatchDirectiveFunction = <T>(\n  signal: Signal.State<T> | Signal.Computed<T>\n) => DirectiveResult<typeof WatchDirective<T>>;\n\n/**\n * Renders a signal and subscribes to it, updating the part when the signal\n * changes.\n *\n * watch() can only be used in a reactive element that applies the\n * SignalWatcher mixin.\n */\nexport const watch = directive(WatchDirective) as WatchDirectiveFunction;\n"],"names":["WatchDirective","AsyncDirective","__watch","undefined","this","__watcher","__computed","Signal","Computed","__signal","_a","get","watcher","subtle","Watcher","__host","_updateWatchDirective","watch","__unwatch","unwatch","_clearWatchDirective","commit","setValue","untrack","render","signal","update","part","_b","options","host","disconnected","reconnected","directive"],"mappings":";;;;;GAWM,MAAOA,UAA0BC,EAW7B,IAAAC,GACN,QAAuBC,IAAnBC,KAAKC,KACP,OAEFD,KAAKE,KAAa,IAAIC,EAAOC,UAAS,WACpC,OAAsB,UAAfJ,KAAKK,YAAU,IAAAC,OAAA,EAAAA,EAAAC,KAAK,IAE7B,MAAMC,EAAWR,KAAKC,KAAY,IAAIE,EAAOM,OAAOC,SAAQ,WAG/C,QAAXJ,EAAAN,KAAKW,YAAM,IAAAL,GAAAA,EAAEM,EAAsBZ,MACnCQ,EAAQK,OAAO,IAEjBL,EAAQK,MAAMb,KAAKE,KACpB,CAEO,IAAAY,cACiBf,IAAnBC,KAAKC,OACPD,KAAKC,KAAUc,QAAQf,KAAKE,MAC5BF,KAAKE,UAAaH,EAClBC,KAAKC,UAAYF,EACN,QAAXO,EAAAN,KAAKW,YAAM,IAAAL,GAAAA,EAAEU,EAAqBhB,MAErC,CAED,MAAAiB,GACEjB,KAAKkB,SAASf,EAAOM,OAAOU,SAAQ,KAAK,IAAAb,EAAC,OAAiB,QAAjBA,EAAAN,KAAKE,YAAY,IAAAI,OAAA,EAAAA,EAAAC,KAAK,IACjE,CAED,MAAAa,CAAOC,GAEL,OAAOlB,EAAOM,OAAOU,SAAQ,IAAME,EAAOd,OAC3C,CAEQ,MAAAe,CACPC,GACCF,YAcD,OAZW,QAAXf,EAAAN,KAAKW,YAAM,IAAAL,IAAXN,KAAKW,KAAuB,QAAZa,EAAAD,EAAKE,eAAO,IAAAD,OAAA,EAAAA,EAAEE,MAC1BL,IAAWrB,KAAKK,WAA8BN,IAAlBC,KAAKK,MAEnCL,KAAKc,OAEPd,KAAKK,KAAWgB,EAChBrB,KAAKF,OAMEK,EAAOM,OAAOU,SAAQ,IAAMnB,KAAKE,KAAYK,OACrD,CAEkB,YAAAoB,GACjB3B,KAAKc,MACN,CAEkB,WAAAc,GACjB5B,KAAKF,MACN,QAcUe,EAAQgB,EAAUjC"}